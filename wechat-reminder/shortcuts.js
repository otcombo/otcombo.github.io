// Generated by CoffeeScript 1.7.1

/*
  Shortcuts for Framer 1.0
  http://github.com/facebook/shortcuts-for-framer

  Copyright (c) 2014, Facebook, Inc.
  All rights reserved.

  Readme:
  https://github.com/facebook/shortcuts-for-framer

  License:
  https://github.com/facebook/shortcuts-for-framer/blob/master/LICENSE.md
 */


/*
  CONFIGURATION
 */

(function() {
  var shortcuts;

  shortcuts = {};

  Framer.Defaults.FadeAnimation = {
    curve: "bezier-curve",
    time: 0.2
  };

  Framer.Defaults.SlideAnimation = {
    curve: "spring(400,40,0)"
  };


  /*
    LOOP ON EVERY LAYER
  
    Shorthand for applying a function to every layer in the document.
  
    Example:
    ```shortcuts.everyLayer(function(layer) {
      layer.visible = false;
    });```
   */

  shortcuts.everyLayer = function(fn) {
    var layerName, _layer, _results;
    _results = [];
    for (layerName in window.Layers) {
      _layer = window.Layers[layerName];
      _results.push(fn(_layer));
    }
    return _results;
  };


  /*
    SHORTHAND FOR ACCESSING LAYERS
  
    Convert each layer coming from the exporter into a Javascript object for shorthand access.
  
    This has to be called manually in Framer3 after you've ran the importer.
  
    myLayers = Framer.Importer.load("...")
    shortcuts.initialize(myLayers)
  
    If you have a layer in your PSD/Sketch called "NewsFeed", this will create a global Javascript variable called "NewsFeed" that you can manipulate with Framer.
  
    Example:
    `NewsFeed.visible = false;`
  
    Notes:
    Javascript has some names reserved for internal function that you can't override (for ex. )
    If you call initialize without anything, it will use all currently available layers.
   */

  shortcuts.initialize = function(layers) {
    var layer;
    if (!layers) {
      layer = Framer.CurrentContext._layerList;
    }
    window.Layers = layers;
    return shortcuts.everyLayer(function(layer) {
      var sanitizedLayerName;
      sanitizedLayerName = layer.name.replace(/[-+!?:*\[\]\(\)\/]/g, '').trim().replace(/\s/g, '_');
      window[sanitizedLayerName] = layer;
      shortcuts.saveOriginalFrame(layer);
      return shortcuts.initializeTouchStates(layer);
    });
  };


  /*
    FIND CHILD LAYERS BY NAME
  
    Retrieves subLayers of selected layer that have a matching name.
  
    getChild: return the first sublayer whose name includes the given string
    getChildren: return all subLayers that match
  
    Useful when eg. iterating over table cells. Use getChild to access the button found in each cell. This is **case insensitive**.
  
    Example:
    `topLayer = NewsFeed.getChild("Top")` Looks for layers whose name matches Top. Returns the first matching layer.
  
    `childLayers = Table.getChildren("Cell")` Returns all children whose name match Cell in an array.
   */

  Layer.prototype.getChild = function(needle, recursive) {
    var subLayer, _i, _j, _len, _len1, _ref, _ref1;
    if (recursive == null) {
      recursive = false;
    }
    _ref = this.subLayers;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      subLayer = _ref[_i];
      if (subLayer.name.toLowerCase().indexOf(needle.toLowerCase()) !== -1) {
        return subLayer;
      }
    }
    if (recursive) {
      _ref1 = this.subLayers;
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        subLayer = _ref1[_j];
        if (subLayer.getChild(needle, recursive)) {
          return subLayer.getChild(needle, recursive);
        }
      }
    }
  };

  Layer.prototype.getChildren = function(needle, recursive) {
    var results, subLayer, _i, _j, _len, _len1, _ref, _ref1;
    if (recursive == null) {
      recursive = false;
    }
    results = [];
    if (recursive) {
      _ref = this.subLayers;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        subLayer = _ref[_i];
        results = results.concat(subLayer.getChildren(needle, recursive));
      }
      if (this.name.toLowerCase().indexOf(needle.toLowerCase()) !== -1) {
        results.push(this);
      }
      return results;
    } else {
      _ref1 = this.subLayers;
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        subLayer = _ref1[_j];
        if (subLayer.name.toLowerCase().indexOf(needle.toLowerCase()) !== -1) {
          results.push(subLayer);
        }
      }
      return results;
    }
  };


  /*
    CONVERT A NUMBER RANGE TO ANOTHER
  
    Converts a number within one range to another range
  
    Example:
    We want to map the opacity of a layer to its x location.
  
    The opacity will be 0 if the X coordinate is 0, and it will be 1 if the X coordinate is 640. All the X coordinates in between will result in intermediate values between 0 and 1.
  
    `myLayer.opacity = convertRange(0, 640, myLayer.x, 0, 1)`
  
    By default, this value might be outside the bounds of NewMin and NewMax if the OldValue is outside OldMin and OldMax. If you want to cap the final value to NewMin and NewMax, set capped to true.
    Make sure NewMin is smaller than NewMax if you're using this. If you need an inverse proportion, try swapping OldMin and OldMax.
   */

  shortcuts.convertRange = function(OldMin, OldMax, OldValue, NewMin, NewMax, capped) {
    var NewRange, NewValue, OldRange;
    OldRange = OldMax - OldMin;
    NewRange = NewMax - NewMin;
    NewValue = (((OldValue - OldMin) * NewRange) / OldRange) + NewMin;
    if (capped) {
      if (NewValue > NewMax) {
        return NewMax;
      } else if (NewValue < NewMin) {
        return NewMin;
      } else {
        return NewValue;
      }
    } else {
      return NewValue;
    }
  };


  /*
    ORIGINAL FRAME
  
    Stores the initial location and size of a layer in the "originalFrame" attribute, so you can revert to it later on.
  
    Example:
    The x coordinate of MyLayer is initially 400 (from the PSD)
  
    ```MyLayer.x = 200; // now we set it to 200.
    MyLayer.x = MyLayer.originalFrame.x // now we set it back to its original value, 400.```
   */

  shortcuts.saveOriginalFrame = function(layer) {
    return layer.originalFrame = layer.frame;
  };


  /*
    SHORTHAND HOVER SYNTAX
  
    Quickly define functions that should run when I hover over a layer, and hover out.
  
    Example:
    `MyLayer.hover(function() { OtherLayer.show() }, function() { OtherLayer.hide() });`
   */

  Layer.prototype.hover = function(enterFunction, leaveFunction) {
    this.on('mouseenter', enterFunction);
    return this.on('mouseleave', leaveFunction);
  };


  /*
    SHORTHAND TAP SYNTAX
  
    Instead of `MyLayer.on(Events.TouchEnd, handler)`, use `MyLayer.tap(handler)`
   */

  Layer.prototype.tap = function(handler) {
    return this.on(Events.TouchEnd, handler);
  };


  /*
    SHORTHAND CLICK SYNTAX
  
    Instead of `MyLayer.on(Events.Click, handler)`, use `MyLayer.click(handler)`
   */

  Layer.prototype.click = function(handler) {
    return this.on(Events.Click, handler);
  };


  /*
    SHORTHAND ANIMATION SYNTAX
  
    A shorter animation syntax that mirrors the jQuery syntax:
    layer.animate(properties, [time], [curve], [callback])
  
    All parameters except properties are optional and can be omitted.
  
    Old:
    ```MyLayer.animate({
      properties: {
        x: 500
      },
      time: 500,
      curve: 'bezier-curve'
    })```
  
    New:
    ```MyLayer.animateTo({
      x: 500
    })```
  
    Optionally (with 1000ms duration and spring):
      ```MyLayer.animateTo({
      x: 500
    }, 1000, "spring(100,10,0)")
   */

  Layer.prototype.animateTo = function(properties, first, second, third) {
    var callback, curve, thisLayer, time;
    thisLayer = this;
    time = curve = callback = null;
    if (typeof first === "number") {
      time = first;
      if (typeof second === "string") {
        curve = second;
        callback = third;
      }
      if (typeof second === "function") {
        callback = second;
      }
    } else if (typeof first === "string") {
      curve = first;
      if (typeof second === "function") {
        callback = second;
      }
    } else if (typeof first === "function") {
      callback = first;
    }
    if ((time != null) && (curve == null)) {
      curve = 'bezier-curve';
    }
    if (curve == null) {
      curve = Framer.Defaults.Animation.curve;
    }
    if (time == null) {
      time = Framer.Defaults.Animation.time;
    }
    thisLayer.animationTo = new Animation({
      layer: thisLayer,
      properties: properties,
      curve: curve,
      time: time
    });
    thisLayer.animationTo.on('start', function() {
      return thisLayer.isAnimating = true;
    });
    thisLayer.animationTo.on('end', function() {
      thisLayer.isAnimating = null;
      if (callback != null) {
        return callback();
      }
    });
    return thisLayer.animationTo.start();
  };


  /*
    ANIMATE MOBILE LAYERS IN AND OUT OF THE VIEWPORT
  
    Shorthand syntax for animating layers in and out of the viewport. Assumes that the layer you are animating is a whole screen and has the same dimensions as your container.
  
    Enable the device preview in Framer Studio to use this – it lets this script figure out what the bounds of your screen are.
  
    Example:
    * `MyLayer.slideToLeft()` will animate the layer **to** the left corner of the screen (from its current position)
  
    * `MyLayer.slideFromLeft()` will animate the layer into the viewport **from** the left corner (from x=-width)
  
    Configuration:
    * (By default we use a spring curve that approximates iOS. To use a time duration, change the curve to bezier-curve.)
    * Framer.Defaults.SlideAnimation.time
    * Framer.Defaults.SlideAnimation.curve
  
  
    How to read the configuration:
    ```slideFromLeft:
      property: "x"     // animate along the X axis
      factor: "width"
      from: -1          // start value: outside the left corner ( x = -width_phone )
      to: 0             // end value: inside the left corner ( x = width_layer )
    ```
   */

  shortcuts.slideAnimations = {
    slideFromLeft: {
      property: "x",
      factor: "width",
      from: -1,
      to: 0
    },
    slideToLeft: {
      property: "x",
      factor: "width",
      to: -1
    },
    slideFromRight: {
      property: "x",
      factor: "width",
      from: 1,
      to: 0
    },
    slideToRight: {
      property: "x",
      factor: "width",
      to: 1
    },
    slideFromTop: {
      property: "y",
      factor: "height",
      from: -1,
      to: 0
    },
    slideToTop: {
      property: "y",
      factor: "height",
      to: -1
    },
    slideFromBottom: {
      property: "y",
      factor: "height",
      from: 1,
      to: 0
    },
    slideToBottom: {
      property: "y",
      factor: "height",
      to: 1
    }
  };

  _.each(shortcuts.slideAnimations, function(opts, name) {
    return Layer.prototype[name] = function(time) {
      var err, _animationConfig, _curve, _factor, _phone, _property, _ref, _ref1, _time;
      _phone = (_ref = Framer.Device) != null ? (_ref1 = _ref.screen) != null ? _ref1.frame : void 0 : void 0;
      if (!_phone) {
        err = "Please select a device preview in Framer Studio to use the slide preset animations.";
        print(err);
        console.log(err);
        return;
      }
      _property = opts.property;
      _factor = _phone[opts.factor];
      if (opts.from != null) {
        this[_property] = opts.from * _factor;
      }
      _animationConfig = {};
      _animationConfig[_property] = opts.to * _factor;
      if (time) {
        _time = time;
        _curve = "bezier-curve";
      } else {
        _time = Framer.Defaults.SlideAnimation.time;
        _curve = Framer.Defaults.SlideAnimation.curve;
      }
      return this.animate({
        properties: _animationConfig,
        time: _time,
        curve: _curve
      });
    };
  });


  /*
    EASY FADE IN / FADE OUT
  
    .show() and .hide() are shortcuts to affect opacity and pointer events. This is essentially the same as hiding with `visible = false` but can be animated.
  
    .fadeIn() and .fadeOut() are shortcuts to fade in a hidden layer, or fade out a visible layer.
  
    These shortcuts work on individual layer objects as well as an array of layers.
  
    Example:
    * `MyLayer.fadeIn()` will fade in MyLayer using default timing.
    * `[MyLayer, OtherLayer].fadeOut(4)` will fade out both MyLayer and OtherLayer over 4 seconds.
  
    To customize the fade animation, change the variables time and curve inside `Framer.Defaults.FadeAnimation`.
   */

  Layer.prototype.show = function() {
    this.opacity = 1;
    this.style.pointerEvents = 'auto';
    return this;
  };

  Layer.prototype.hide = function() {
    this.opacity = 0;
    this.style.pointerEvents = 'none';
    return this;
  };

  Layer.prototype.fadeIn = function(time) {
    if (time == null) {
      time = Framer.Defaults.FadeAnimation.time;
    }
    if (this.opacity === 1) {
      return;
    }
    if (!this.visible) {
      this.opacity = 0;
      this.visible = true;
    }
    return this.animateTo({
      opacity: 1
    }, time, Framer.Defaults.FadeAnimation.curve);
  };

  Layer.prototype.fadeOut = function(time) {
    var that;
    if (time == null) {
      time = Framer.Defaults.FadeAnimation.time;
    }
    if (this.opacity === 0) {
      return;
    }
    that = this;
    return this.animateTo({
      opacity: 0
    }, time, Framer.Defaults.FadeAnimation.curve, function() {
      return that.style.pointerEvents = 'none';
    });
  };

  _.each(['show', 'hide', 'fadeIn', 'fadeOut'], function(fnString) {
    return Object.defineProperty(Array.prototype, fnString, {
      enumerable: false,
      value: function(time) {
        _.each(this, function(layer) {
          if (layer instanceof Layer) {
            return Layer.prototype[fnString].call(layer, time);
          }
        });
        return this;
      }
    });
  });


  /*
    EASY HOVER AND TOUCH/CLICK STATES FOR LAYERS
  
    By naming your layer hierarchy in the following way, you can automatically have your layers react to hovers, clicks or taps.
  
    Button_touchable
    - Button_default (default state)
    - Button_down (touch/click state)
    - Button_hover (hover)
   */

  shortcuts.initializeTouchStates = function(layer) {
    var hitTarget, _default, _down, _hover;
    _default = layer.getChild('default');
    if (layer.name.toLowerCase().indexOf('touchable') && _default) {
      if (!Framer.Utils.isMobile()) {
        _hover = layer.getChild('hover');
      }
      _down = layer.getChild('down');
      if (_hover != null) {
        _hover.hide();
      }
      if (_down != null) {
        _down.hide();
      }
      if (_hover || _down) {
        hitTarget = new Layer({
          background: 'transparent',
          frame: _default.frame
        });
        hitTarget.superLayer = layer;
        hitTarget.bringToFront();
      }
      if (_hover) {
        layer.hover(function() {
          _default.hide();
          return _hover.show();
        }, function() {
          _default.show();
          return _hover.hide();
        });
      }
      if (_down) {
        layer.on(Events.TouchStart, function() {
          _default.hide();
          if (_hover != null) {
            _hover.hide();
          }
          return _down.show();
        });
        return layer.on(Events.TouchEnd, function() {
          _down.hide();
          if (_hover) {
            return _hover.show();
          } else {
            return _default.show();
          }
        });
      }
    }
  };

  _.extend(exports, shortcuts);

}).call(this);
